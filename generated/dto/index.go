package dto

import (
	"github.com/dave/jennifer/jen"
	"github.com/iancoleman/strcase"
	"metis/generated/helper"
	"time"
)

type GenDto struct {
}

func (rec *GenDto) genStructDto(table string, columns []helper.Column) jen.Code {
	camel := strcase.ToCamel(table)
	return jen.Line().Comment(camel + " 自动生成").Line().Type().Id(camel).Add(helper.UseEntity(camel))
}

func (rec *GenDto) genFuncNewAccount(table string, columns []helper.Column) jen.Code {
	camel := strcase.ToCamel(table)
	return jen.Line().Comment("New" + camel + " 初始化").Line().Func().Id("New" + camel).Params().Params(jen.Op("*").Id(camel)).Block(
		jen.Return(jen.Op("&").Id(camel).Values()),
	)
}

func (rec *GenDto) genFuncFrom(table string, columns []helper.Column) jen.Code {
	camel := strcase.ToCamel(table)
	codes := make([]jen.Code, len(columns))
	for i, column := range columns {
		codes[i] = jen.Add(
			helper.RenderStarField(
				"rec", strcase.ToCamel(column.ColumnName),
			),
		).Op("=").Add(helper.RenderStarField("from", strcase.ToCamel(column.ColumnName)))
	}
	return jen.Line().Comment("From 读取 entity").Line().Func().Params(jen.Id("rec").Op("*").Id(camel)).Id("From").
		Params(jen.Id("from").Op("*").Add(helper.UseEntity(camel))).
		Params().Block(codes...)
}

func (rec *GenDto) genFuncInto(table string, columns []helper.Column) jen.Code {
	camel := strcase.ToCamel(table)
	codes := make([]jen.Code, len(columns))
	for i, column := range columns {
		codes[i] = jen.Add(helper.RenderStarField("into", strcase.ToCamel(column.ColumnName))).Op("=").
			Add(helper.RenderStarField("rec", strcase.ToCamel(column.ColumnName)))
	}
	return jen.Line().Comment("Into 写入 entity").Line().Func().Params(jen.Id("rec").Op("*").Id(camel)).Id("Into").
		Params(jen.Id("into").Op("*").Add(helper.UseEntity(camel))).
		Params().Block(codes...)
}

func (rec *GenDto) GenFile(table string, columns []helper.Column) *jen.File {
	file := jen.NewFile("dto")

	file.HeaderComment("Code generated by tabuyos. DO NOT EDIT.")
	file.PackageComment("Package dto")
	file.PackageComment("@author tabuyos")
	file.PackageComment("@since " + time.Now().Format("2006/01/02"))
	file.PackageComment("@description " + table)

	file.Add(rec.genStructDto(table, columns))
	return file
}
